name: Daily Dropbox Report

on:
  schedule:
    # Runs daily at 9:00 AM UTC (5:00 AM EST / 4:00 AM EDT)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install dropbox requests

      - name: Generate and upload report
        env:
          DROPBOX_ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
          DROPBOX_ROOT_PATH: ${{ secrets.DROPBOX_ROOT_PATH }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: dropbox-report
        run: |
          python << 'EOF'
          import os
          import base64
          import requests
          import dropbox
          from dropbox.files import FolderMetadata, FileMetadata
          from datetime import datetime, timedelta
          import json

          # === Dropbox Scanner ===
          def scan_dropbox_folder(access_token, root_path):
              dbx = dropbox.Dropbox(access_token)
              results = []

              if root_path and not root_path.startswith('/'):
                  root_path = '/' + root_path
              if root_path == '/':
                  root_path = ''

              folders_to_scan = [root_path]

              while folders_to_scan:
                  current_path = folders_to_scan.pop(0)
                  file_count = 0

                  try:
                      result = dbx.files_list_folder(current_path)
                      entries = result.entries

                      while result.has_more:
                          result = dbx.files_list_folder_continue(result.cursor)
                          entries.extend(result.entries)

                      for entry in entries:
                          if isinstance(entry, FileMetadata):
                              file_count += 1
                          elif isinstance(entry, FolderMetadata):
                              folders_to_scan.append(entry.path_lower)

                      display_path = current_path if current_path else '/'
                      results.append({'path': display_path, 'file_count': file_count})

                  except Exception as e:
                      print(f"Error scanning {current_path}: {e}")
                      display_path = current_path if current_path else '/'
                      results.append({'path': display_path, 'file_count': -1})

              results.sort(key=lambda x: x['path'].lower())
              return results

          # === History Manager ===
          def fetch_history_from_github(token, owner, repo):
              """Fetch existing history.json from GitHub."""
              url = f"https://api.github.com/repos/{owner}/{repo}/contents/history.json"
              headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github.v3+json"}
              r = requests.get(url, headers=headers)
              if r.status_code == 200:
                  content_b64 = r.json().get('content', '')
                  content = base64.b64decode(content_b64).decode('utf-8')
                  try:
                      return json.loads(content)
                  except json.JSONDecodeError:
                      print("Warning: Could not parse history.json, starting fresh")
                      return {"data": []}
              else:
                  print(f"No existing history found (status {r.status_code}), starting fresh")
                  return {"data": []}

          def append_to_history(history, date, total_files, total_folders):
              """Add today's data to history."""
              history['data'] = [e for e in history.get('data', []) if e.get('date') != date]
              history['data'].append({'date': date, 'total_files': total_files, 'total_folders': total_folders})
              history['data'].sort(key=lambda x: x['date'])
              return history

          def trim_history(history, days=14):
              """Keep only the last N days of history."""
              cutoff = (datetime.utcnow() - timedelta(days=days)).strftime('%Y-%m-%d')
              history['data'] = [e for e in history.get('data', []) if e.get('date', '') >= cutoff]
              return history

          def save_history_to_github(token, owner, repo, history):
              """Save history.json to GitHub."""
              url = f"https://api.github.com/repos/{owner}/{repo}/contents/history.json"
              headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github.v3+json"}
              content = json.dumps(history, indent=2)
              content_b64 = base64.b64encode(content.encode()).decode()
              r = requests.get(url, headers=headers)
              sha = r.json().get('sha') if r.status_code == 200 else None
              data = {"message": "Update history data", "content": content_b64, "branch": "main"}
              if sha:
                  data["sha"] = sha
              r = requests.put(url, headers=headers, json=data)
              if r.status_code not in [200, 201]:
                  raise Exception(f"GitHub API error saving history: {r.status_code} - {r.text}")
              print(f"History saved ({len(history.get('data', []))} entries)")

          # === HTML Generator ===
          def generate_html_report(folder_data, root_path, history_data=None):
              timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
              total_folders = len(folder_data)
              total_files = sum(f['file_count'] for f in folder_data if f['file_count'] >= 0)

              table_rows = []
              for folder in folder_data:
                  path = folder['path']
                  count = folder['file_count']
                  display_path = path
                  if root_path and path.lower().startswith(root_path.lower()):
                      display_path = path[len(root_path):]
                      if not display_path:
                          display_path = '/'
                      elif not display_path.startswith('/'):
                          display_path = '/' + display_path
                  table_rows.append({'path': display_path, 'file_count': count})

              table_data_json = json.dumps(table_rows)

              # Prepare chart data
              chart_html = ""
              chart_script = ""
              change_indicator_html = ""

              if history_data and history_data.get('data'):
                  data_points = history_data['data']
                  chart_labels = json.dumps([e.get('date', '') for e in data_points])
                  chart_values = json.dumps([e.get('total_files', 0) for e in data_points])

                  if len(data_points) >= 2:
                      today_files = data_points[-1].get('total_files', 0)
                      yesterday_files = data_points[-2].get('total_files', 0)
                      change = today_files - yesterday_files
                      if change < 0:
                          change_color, change_icon = "#28a745", "&#x2193;"
                          change_text = f"{abs(change):,} files"
                      elif change > 0:
                          change_color, change_icon = "#dc3545", "&#x2191;"
                          change_text = f"{change:,} files"
                      else:
                          change_color, change_icon = "#666", "&#x2192;"
                          change_text = "No change"
                      change_indicator_html = f'''
                      <div class="stat-box change-box">
                          <div class="label">Change from Yesterday</div>
                          <div class="value" style="color: {change_color};"><span style="font-size: 18px;">{change_icon}</span> {change_text}</div>
                      </div>'''

                  chart_html = '''
                  <div class="chart-container">
                      <h2 class="chart-title">14-Day Progress</h2>
                      <canvas id="progressChart"></canvas>
                  </div>'''

                  chart_script = f'''
                  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                  <script>
                      const ctx = document.getElementById('progressChart').getContext('2d');
                      new Chart(ctx, {{
                          type: 'line',
                          data: {{
                              labels: {chart_labels},
                              datasets: [{{
                                  label: 'Total Files',
                                  data: {chart_values},
                                  borderColor: '#0061fe',
                                  backgroundColor: 'rgba(0, 97, 254, 0.1)',
                                  borderWidth: 2,
                                  fill: true,
                                  tension: 0.3,
                                  pointBackgroundColor: '#0061fe',
                                  pointBorderColor: '#fff',
                                  pointBorderWidth: 2,
                                  pointRadius: 4,
                                  pointHoverRadius: 6
                              }}]
                          }},
                          options: {{
                              responsive: true,
                              maintainAspectRatio: false,
                              plugins: {{
                                  legend: {{ display: false }},
                                  tooltip: {{
                                      callbacks: {{
                                          label: function(context) {{ return context.parsed.y.toLocaleString() + ' files'; }}
                                      }}
                                  }}
                              }},
                              scales: {{
                                  y: {{
                                      beginAtZero: false,
                                      ticks: {{ callback: function(value) {{ return value.toLocaleString(); }} }}
                                  }},
                                  x: {{ grid: {{ display: false }} }}
                              }}
                          }}
                      }});
                  </script>'''

              html = f'''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Dropbox Folder File Count Report</title>
              <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
              <style>
                  * {{ box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; color: #333; }}
                  .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                  h1 {{ margin: 0 0 10px 0; color: #0061fe; font-size: 24px; }}
                  .meta-info {{ color: #666; font-size: 14px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }}
                  .chart-container {{ margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 6px; height: 250px; }}
                  .chart-title {{ margin: 0 0 15px 0; font-size: 16px; color: #333; font-weight: 600; }}
                  #progressChart {{ max-height: 180px; }}
                  .stats {{ display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }}
                  .stat-box {{ background: #f8f9fa; padding: 15px 20px; border-radius: 6px; border-left: 4px solid #0061fe; }}
                  .stat-box.change-box {{ border-left-color: #6c757d; }}
                  .stat-box .label {{ font-size: 12px; color: #666; text-transform: uppercase; }}
                  .stat-box .value {{ font-size: 24px; font-weight: bold; color: #333; }}
                  .search-box {{ margin-bottom: 15px; }}
                  .search-box input {{ padding: 10px 15px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }}
                  .search-box input:focus {{ outline: none; border-color: #0061fe; }}
                  .tabulator {{ border: 1px solid #ddd; border-radius: 4px; }}
                  .tabulator-row:nth-child(even) {{ background-color: #f9f9f9; }}
                  .tabulator-row:hover {{ background-color: #e8f4ff !important; }}
                  .tabulator-header {{ background-color: #f8f9fa; border-bottom: 2px solid #0061fe; }}
                  .footer {{ margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #999; text-align: center; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Dropbox Folder File Count Report</h1>
                  <div class="meta-info"><span><strong>Generated:</strong> {timestamp}</span></div>
                  {chart_html}
                  <div class="stats">
                      <div class="stat-box"><div class="label">Total Folders</div><div class="value">{total_folders:,}</div></div>
                      <div class="stat-box"><div class="label">Total Files</div><div class="value">{total_files:,}</div></div>
                      {change_indicator_html}
                  </div>
                  <div class="search-box"><input type="text" id="search-input" placeholder="Search folders..."></div>
                  <div id="folder-table"></div>
                  <div class="footer">Report generated automatically</div>
              </div>
              <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
              {chart_script}
              <script>
                  const tableData = {table_data_json};
                  const table = new Tabulator("#folder-table", {{
                      data: tableData, layout: "fitColumns", pagination: "local", paginationSize: 50,
                      paginationSizeSelector: [25, 50, 100, 250, true],
                      columns: [
                          {{ title: "Folder Path", field: "path", sorter: "string", widthGrow: 3,
                            formatter: function(cell) {{ return '<span style="font-family: monospace;">' + cell.getValue() + '</span>'; }} }},
                          {{ title: "File Count", field: "file_count", sorter: "number", hozAlign: "right", headerHozAlign: "right", width: 150,
                            formatter: function(cell) {{ const v = cell.getValue(); return v < 0 ? '<span style="color: #dc3545;">Error</span>' : v.toLocaleString(); }} }}
                      ],
                      initialSort: [{{ column: "path", dir: "asc" }}]
                  }});
                  document.getElementById("search-input").addEventListener("input", function(e) {{
                      table.setFilter("path", "like", e.target.value.toLowerCase());
                  }});
              </script>
          </body>
          </html>'''
              return html

          # === GitHub Uploader ===
          def upload_to_github(token, owner, repo, html_content):
              url = f"https://api.github.com/repos/{owner}/{repo}/contents/index.html"
              headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github.v3+json"}

              # Get existing file SHA
              r = requests.get(url, headers=headers)
              sha = r.json().get('sha') if r.status_code == 200 else None

              data = {
                  "message": "Update Dropbox folder report",
                  "content": base64.b64encode(html_content.encode()).decode(),
                  "branch": "main"
              }
              if sha:
                  data["sha"] = sha

              r = requests.put(url, headers=headers, json=data)
              if r.status_code not in [200, 201]:
                  raise Exception(f"GitHub API error: {r.status_code} - {r.text}")

              return f"https://{owner}.github.io/{repo}/"

          # === Main ===
          dropbox_token = os.environ['DROPBOX_ACCESS_TOKEN']
          dropbox_root = os.environ.get('DROPBOX_ROOT_PATH', '')
          github_token = os.environ['GITHUB_TOKEN']
          github_owner = os.environ['GITHUB_OWNER']
          github_repo = os.environ['GITHUB_REPO']

          # Fetch existing history
          print("Fetching history from GitHub...")
          history = fetch_history_from_github(github_token, github_owner, github_repo)
          print(f"Loaded {len(history.get('data', []))} history entries")

          # Scan Dropbox
          print(f"Scanning Dropbox folder...")
          folder_data = scan_dropbox_folder(dropbox_token, dropbox_root)
          print(f"Found {len(folder_data)} folders")

          # Calculate totals
          total_files = sum(f['file_count'] for f in folder_data if f['file_count'] >= 0)
          total_folders = len(folder_data)

          # Update history
          today = datetime.utcnow().strftime('%Y-%m-%d')
          history = append_to_history(history, today, total_files, total_folders)
          history = trim_history(history, days=14)
          print(f"History now has {len(history.get('data', []))} entries")

          # Generate HTML report with history
          print("Generating HTML report with trend chart...")
          html = generate_html_report(folder_data, dropbox_root, history)

          # Upload both files
          print("Uploading to GitHub...")
          url = upload_to_github(github_token, github_owner, github_repo, html)
          save_history_to_github(github_token, github_owner, github_repo, history)
          print(f"Report uploaded: {url}")
          EOF

